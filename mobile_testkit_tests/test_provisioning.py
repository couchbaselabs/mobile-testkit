import json
import pytest

from keywords.couchbaseserver import CouchbaseServer


SERVER_INFO_MOCK_WITH_ZEROS = """{
   "tasks":{
      "uri":"/pools/default/tasks?v=68571690"
   },
   "indexStatusURI":"/indexStatus?v=21137658",
   "rebalanceStatus":"none",
   "maxBucketCount":10,
   "memoryQuota":960,
   "rebalanceProgressUri":"/pools/default/rebalanceProgress",
   "alerts":[

   ],
   "alertsSilenceURL":"/controller/resetAlerts?token=0&uuid=f9799eb2e4ea73aa2a820bf3a97e3f87",
   "autoCompactionSettings":{
      "viewFragmentationThreshold":{
         "percentage":30,
         "size":"undefined"
      },
      "parallelDBAndViewCompaction":false,
      "indexFragmentationThreshold":{
         "percentage":30
      },
      "indexCircularCompaction":{
         "interval":{
            "abortOutside":false,
            "fromHour":0,
            "toMinute":0,
            "fromMinute":0,
            "toHour":0
         },
         "daysOfWeek":"Sunday,Monday,Tuesday,Wednesday,Thursday,Friday,Saturday"
      },
      "indexCompactionMode":"circular",
      "databaseFragmentationThreshold":{
         "percentage":30,
         "size":"undefined"
      }
   },
   "nodes":[
      {
         "status":"healthy",
         "couchApiBase":"http://192.168.33.10:8092/",
         "uptime":"24",
         "clusterMembership":"active",
         "couchApiBaseHTTPS":"https://192.168.33.10:18092/",
         "mcdMemoryReserved":1472,
         "memoryFree":1542975488,
         "memoryTotal":1929396224,
         "hostname":"192.168.33.10:8091",
         "services":[
            "index",
            "kv",
            "n1ql"
         ],
         "thisNode":true,
         "clusterCompatibility":262150,
         "version":"4.6.0-3573-enterprise",
         "otpNode":"ns_1@192.168.33.10",
         "mcdMemoryAllocated":1472,
         "otpCookie":"795269142d574f74e668c6b4c1d80171a02c27ff62c8db9b9890fce83a494eff",
         "recoveryType":"none",
         "systemStats":{
            "swap_total":1610608640,
            "mem_free":1542975488,
            "swap_used":0,
            "cpu_utilization_rate":0,
            "mem_total":1929396224
         },
         "os":"x86_64-unknown-linux-gnu",
         "ports":{
            "direct":11210,
            "httpsMgmt":18091,
            "proxy":11211,
            "sslProxy":11214,
            "httpsCAPI":18092
         },
         "interestingStats":{

         }
      },
      {
         "status":"healthy",
         "couchApiBase":"http://192.168.33.11:8092/",
         "uptime":"24",
         "clusterMembership":"active",
         "couchApiBaseHTTPS":"https://192.168.33.11:18092/",
         "mcdMemoryReserved":0,
         "memoryFree":0,
         "memoryTotal":0,
         "hostname":"192.168.33.11:8091",
         "services":[
            "kv"
         ],
         "clusterCompatibility":262150,
         "version":"4.6.0-3573-enterprise",
         "otpNode":"ns_1@192.168.33.11",
         "mcdMemoryAllocated":0,
         "otpCookie":"795269142d574f74e668c6b4c1d80171a02c27ff62c8db9b9890fce83a494eff",
         "recoveryType":"none",
         "systemStats":{
            "swap_total":0,
            "mem_free":0,
            "swap_used":0,
            "cpu_utilization_rate":0,
            "mem_total":0
         },
         "os":"x86_64-unknown-linux-gnu",
         "ports":{
            "direct":11210,
            "httpsMgmt":18091,
            "proxy":11211,
            "sslProxy":11214,
            "httpsCAPI":18092
         },
         "interestingStats":{

         }
      },
      {
         "status":"healthy",
         "couchApiBase":"http://192.168.33.12:8092/",
         "uptime":"27",
         "clusterMembership":"active",
         "couchApiBaseHTTPS":"https://192.168.33.12:18092/",
         "mcdMemoryReserved":0,
         "memoryFree":0,
         "memoryTotal":0,
         "hostname":"192.168.33.12:8091",
         "services":[
            "kv"
         ],
         "clusterCompatibility":262150,
         "version":"4.6.0-3573-enterprise",
         "otpNode":"ns_1@192.168.33.12",
         "mcdMemoryAllocated":0,
         "otpCookie":"795269142d574f74e668c6b4c1d80171a02c27ff62c8db9b9890fce83a494eff",
         "recoveryType":"none",
         "systemStats":{
            "swap_total":0,
            "mem_free":0,
            "swap_used":0,
            "cpu_utilization_rate":0,
            "mem_total":0
         },
         "os":"x86_64-unknown-linux-gnu",
         "ports":{
            "direct":11210,
            "httpsMgmt":18091,
            "proxy":11211,
            "sslProxy":11214,
            "httpsCAPI":18092
         },
         "interestingStats":{

         }
      }
   ],
   "counters":{
      "rebalance_success":1,
      "rebalance_start":1
   },
   "ftsMemoryQuota":256,
   "clusterName":"",
   "buckets":{
      "uri":"/pools/default/buckets?v=126753042&uuid=f9799eb2e4ea73aa2a820bf3a97e3f87",
      "terseStreamingBucketsBase":"/pools/default/bs/",
      "terseBucketsBase":"/pools/default/b/"
   },
   "stopRebalanceUri":"/controller/stopRebalance?uuid=f9799eb2e4ea73aa2a820bf3a97e3f87",
   "indexMemoryQuota":512,
   "remoteClusters":{
      "validateURI":"/pools/default/remoteClusters?just_validate=1",
      "uri":"/pools/default/remoteClusters?uuid=f9799eb2e4ea73aa2a820bf3a97e3f87"
   },
   "name":"default",
   "serverGroupsUri":"/pools/default/serverGroups?v=63074012",
   "nodeStatusesUri":"/nodeStatuses",
   "controllers":{
      "clusterLogsCollection":{
         "startURI":"/controller/startLogsCollection?uuid=f9799eb2e4ea73aa2a820bf3a97e3f87",
         "cancelURI":"/controller/cancelLogsCollection?uuid=f9799eb2e4ea73aa2a820bf3a97e3f87"
      },
      "setAutoCompaction":{
         "validateURI":"/controller/setAutoCompaction?just_validate=1",
         "uri":"/controller/setAutoCompaction?uuid=f9799eb2e4ea73aa2a820bf3a97e3f87"
      },
      "addNode":{
         "uri":"/controller/addNodeV2?uuid=f9799eb2e4ea73aa2a820bf3a97e3f87"
      },
      "failOver":{
         "uri":"/controller/failOver?uuid=f9799eb2e4ea73aa2a820bf3a97e3f87"
      },
      "reAddNode":{
         "uri":"/controller/reAddNode?uuid=f9799eb2e4ea73aa2a820bf3a97e3f87"
      },
      "startGracefulFailover":{
         "uri":"/controller/startGracefulFailover?uuid=f9799eb2e4ea73aa2a820bf3a97e3f87"
      },
      "replication":{
         "createURI":"/controller/createReplication?uuid=f9799eb2e4ea73aa2a820bf3a97e3f87",
         "validateURI":"/controller/createReplication?just_validate=1"
      },
      "ejectNode":{
         "uri":"/controller/ejectNode?uuid=f9799eb2e4ea73aa2a820bf3a97e3f87"
      },
      "setRecoveryType":{
         "uri":"/controller/setRecoveryType?uuid=f9799eb2e4ea73aa2a820bf3a97e3f87"
      },
      "reFailOver":{
         "uri":"/controller/reFailOver?uuid=f9799eb2e4ea73aa2a820bf3a97e3f87"
      },
      "rebalance":{
         "uri":"/controller/rebalance?uuid=f9799eb2e4ea73aa2a820bf3a97e3f87"
      }
   },
   "checkPermissionsURI":"/pools/default/checkPermissions?v=125619376",
   "storageTotals":{
      "hdd":{
         "free":116487031359,
         "total":121340657664,
         "quotaTotal":121340657664,
         "usedByData":0,
         "used":4853626305
      },
      "ram":{
         "used":3081224192,
         "quotaUsed":0,
         "quotaUsedPerNode":0,
         "quotaTotalPerNode":1006632960,
         "total":5788188672,
         "quotaTotal":3019898880,
         "usedByData":0
      }
   }
}"""

SERVER_INFO_MOCK_WITH_DIFFERENT_SIZES = """{
   "tasks":{
      "uri":"/pools/default/tasks?v=68571690"
   },
   "indexStatusURI":"/indexStatus?v=21137658",
   "rebalanceStatus":"none",
   "maxBucketCount":10,
   "memoryQuota":960,
   "rebalanceProgressUri":"/pools/default/rebalanceProgress",
   "alerts":[

   ],
   "alertsSilenceURL":"/controller/resetAlerts?token=0&uuid=f9799eb2e4ea73aa2a820bf3a97e3f87",
   "autoCompactionSettings":{
      "viewFragmentationThreshold":{
         "percentage":30,
         "size":"undefined"
      },
      "parallelDBAndViewCompaction":false,
      "indexFragmentationThreshold":{
         "percentage":30
      },
      "indexCircularCompaction":{
         "interval":{
            "abortOutside":false,
            "fromHour":0,
            "toMinute":0,
            "fromMinute":0,
            "toHour":0
         },
         "daysOfWeek":"Sunday,Monday,Tuesday,Wednesday,Thursday,Friday,Saturday"
      },
      "indexCompactionMode":"circular",
      "databaseFragmentationThreshold":{
         "percentage":30,
         "size":"undefined"
      }
   },
   "nodes":[
      {
         "status":"healthy",
         "couchApiBase":"http://192.168.33.10:8092/",
         "uptime":"24",
         "clusterMembership":"active",
         "couchApiBaseHTTPS":"https://192.168.33.10:18092/",
         "mcdMemoryReserved":1472,
         "memoryFree":1542975488,
         "memoryTotal":1929396224,
         "hostname":"192.168.33.10:8091",
         "services":[
            "index",
            "kv",
            "n1ql"
         ],
         "thisNode":true,
         "clusterCompatibility":262150,
         "version":"4.6.0-3573-enterprise",
         "otpNode":"ns_1@192.168.33.10",
         "mcdMemoryAllocated":1472,
         "otpCookie":"795269142d574f74e668c6b4c1d80171a02c27ff62c8db9b9890fce83a494eff",
         "recoveryType":"none",
         "systemStats":{
            "swap_total":1610608640,
            "mem_free":1542975488,
            "swap_used":0,
            "cpu_utilization_rate":0,
            "mem_total":1929396224
         },
         "os":"x86_64-unknown-linux-gnu",
         "ports":{
            "direct":11210,
            "httpsMgmt":18091,
            "proxy":11211,
            "sslProxy":11214,
            "httpsCAPI":18092
         },
         "interestingStats":{

         }
      },
      {
         "status":"healthy",
         "couchApiBase":"http://192.168.33.11:8092/",
         "uptime":"24",
         "clusterMembership":"active",
         "couchApiBaseHTTPS":"https://192.168.33.11:18092/",
         "mcdMemoryReserved":0,
         "memoryFree":0,
         "memoryTotal":0,
         "hostname":"192.168.33.11:8091",
         "services":[
            "kv"
         ],
         "clusterCompatibility":262150,
         "version":"4.6.0-3573-enterprise",
         "otpNode":"ns_1@192.168.33.11",
         "mcdMemoryAllocated":0,
         "otpCookie":"795269142d574f74e668c6b4c1d80171a02c27ff62c8db9b9890fce83a494eff",
         "recoveryType":"none",
         "systemStats":{
            "swap_total":0,
            "mem_free":0,
            "swap_used":0,
            "cpu_utilization_rate":0,
            "mem_total": 180000
         },
         "os":"x86_64-unknown-linux-gnu",
         "ports":{
            "direct":11210,
            "httpsMgmt":18091,
            "proxy":11211,
            "sslProxy":11214,
            "httpsCAPI":18092
         },
         "interestingStats":{

         }
      },
      {
         "status":"healthy",
         "couchApiBase":"http://192.168.33.12:8092/",
         "uptime":"27",
         "clusterMembership":"active",
         "couchApiBaseHTTPS":"https://192.168.33.12:18092/",
         "mcdMemoryReserved":0,
         "memoryFree":0,
         "memoryTotal":0,
         "hostname":"192.168.33.12:8091",
         "services":[
            "kv"
         ],
         "clusterCompatibility":262150,
         "version":"4.6.0-3573-enterprise",
         "otpNode":"ns_1@192.168.33.12",
         "mcdMemoryAllocated":0,
         "otpCookie":"795269142d574f74e668c6b4c1d80171a02c27ff62c8db9b9890fce83a494eff",
         "recoveryType":"none",
         "systemStats":{
            "swap_total":0,
            "mem_free":0,
            "swap_used":0,
            "cpu_utilization_rate":0,
            "mem_total":0
         },
         "os":"x86_64-unknown-linux-gnu",
         "ports":{
            "direct":11210,
            "httpsMgmt":18091,
            "proxy":11211,
            "sslProxy":11214,
            "httpsCAPI":18092
         },
         "interestingStats":{

         }
      }
   ],
   "counters":{
      "rebalance_success":1,
      "rebalance_start":1
   },
   "ftsMemoryQuota":256,
   "clusterName":"",
   "buckets":{
      "uri":"/pools/default/buckets?v=126753042&uuid=f9799eb2e4ea73aa2a820bf3a97e3f87",
      "terseStreamingBucketsBase":"/pools/default/bs/",
      "terseBucketsBase":"/pools/default/b/"
   },
   "stopRebalanceUri":"/controller/stopRebalance?uuid=f9799eb2e4ea73aa2a820bf3a97e3f87",
   "indexMemoryQuota":512,
   "remoteClusters":{
      "validateURI":"/pools/default/remoteClusters?just_validate=1",
      "uri":"/pools/default/remoteClusters?uuid=f9799eb2e4ea73aa2a820bf3a97e3f87"
   },
   "name":"default",
   "serverGroupsUri":"/pools/default/serverGroups?v=63074012",
   "nodeStatusesUri":"/nodeStatuses",
   "controllers":{
      "clusterLogsCollection":{
         "startURI":"/controller/startLogsCollection?uuid=f9799eb2e4ea73aa2a820bf3a97e3f87",
         "cancelURI":"/controller/cancelLogsCollection?uuid=f9799eb2e4ea73aa2a820bf3a97e3f87"
      },
      "setAutoCompaction":{
         "validateURI":"/controller/setAutoCompaction?just_validate=1",
         "uri":"/controller/setAutoCompaction?uuid=f9799eb2e4ea73aa2a820bf3a97e3f87"
      },
      "addNode":{
         "uri":"/controller/addNodeV2?uuid=f9799eb2e4ea73aa2a820bf3a97e3f87"
      },
      "failOver":{
         "uri":"/controller/failOver?uuid=f9799eb2e4ea73aa2a820bf3a97e3f87"
      },
      "reAddNode":{
         "uri":"/controller/reAddNode?uuid=f9799eb2e4ea73aa2a820bf3a97e3f87"
      },
      "startGracefulFailover":{
         "uri":"/controller/startGracefulFailover?uuid=f9799eb2e4ea73aa2a820bf3a97e3f87"
      },
      "replication":{
         "createURI":"/controller/createReplication?uuid=f9799eb2e4ea73aa2a820bf3a97e3f87",
         "validateURI":"/controller/createReplication?just_validate=1"
      },
      "ejectNode":{
         "uri":"/controller/ejectNode?uuid=f9799eb2e4ea73aa2a820bf3a97e3f87"
      },
      "setRecoveryType":{
         "uri":"/controller/setRecoveryType?uuid=f9799eb2e4ea73aa2a820bf3a97e3f87"
      },
      "reFailOver":{
         "uri":"/controller/reFailOver?uuid=f9799eb2e4ea73aa2a820bf3a97e3f87"
      },
      "rebalance":{
         "uri":"/controller/rebalance?uuid=f9799eb2e4ea73aa2a820bf3a97e3f87"
      }
   },
   "checkPermissionsURI":"/pools/default/checkPermissions?v=125619376",
   "storageTotals":{
      "hdd":{
         "free":116487031359,
         "total":121340657664,
         "quotaTotal":121340657664,
         "usedByData":0,
         "used":4853626305
      },
      "ram":{
         "used":3081224192,
         "quotaUsed":0,
         "quotaUsedPerNode":0,
         "quotaTotalPerNode":1006632960,
         "total":5788188672,
         "quotaTotal":3019898880,
         "usedByData":0
      }
   }
}"""


def test_get_mem_total_lowest_with_zeros():
    server = CouchbaseServer("http://localhost:8091")
    server_info = json.loads(SERVER_INFO_MOCK_WITH_ZEROS)
    lowest_mem = server._get_mem_total_lowest(server_info)
    assert lowest_mem == 1929396224


def test_get_mem_total_lowest_with_nonuniform_mem():
    server = CouchbaseServer("http://localhost:8091")
    server_info = json.loads(SERVER_INFO_MOCK_WITH_DIFFERENT_SIZES)
    lowest_mem = server._get_mem_total_lowest(server_info)
    assert lowest_mem == 180000